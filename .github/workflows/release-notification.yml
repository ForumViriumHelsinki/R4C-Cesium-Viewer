name: Release Notification

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Extract release info
        id: release
        uses: actions/github-script@v8
        with:
          script: |
            const version = context.payload.release.tag_name;
            core.setOutput('version', version);

            // Convert markdown to HTML using GitHub's API (handles all edge cases properly)
            const releaseBody = context.payload.release.body || '';

            try {
              const { data: htmlResult } = await github.rest.markdown.render({
                text: releaseBody,
                mode: 'gfm',
                context: `${context.repo.owner}/${context.repo.repo}`
              });

              // Clean up GitHub's HTML for Google Chat Cards v2
              // Cards v2 supports: <b>, <i>, <a>, <br>, basic text
              let cleanHtml = htmlResult
                // Convert <strong> to <b>
                .replace(/<strong>/g, '<b>')
                .replace(/<\/strong>/g, '</b>')
                // Convert <em> to <i>
                .replace(/<em>/g, '<i>')
                .replace(/<\/em>/g, '</i>')
                // Convert headers to bold
                .replace(/<h[1-6][^>]*>/g, '<b>')
                .replace(/<\/h[1-6]>/g, '</b><br>')
                // Convert list items to bullet points
                .replace(/<li>/g, 'â€¢ ')
                .replace(/<\/li>/g, '<br>')
                // Remove ul/ol tags
                .replace(/<\/?ul>/g, '')
                .replace(/<\/?ol>/g, '')
                // Convert paragraphs to line breaks
                .replace(/<p>/g, '')
                .replace(/<\/p>/g, '<br>')
                // Remove code blocks but keep inline code
                .replace(/<pre><code[^>]*>[\s\S]*?<\/code><\/pre>/g, '[code block]')
                .replace(/<code>/g, '')
                .replace(/<\/code>/g, '')
                // Remove any remaining HTML tags not supported by Google Chat
                .replace(/<(?!\/?(b|i|a|br)[ >])[^>]+>/g, '')
                // Clean up multiple consecutive line breaks
                .replace(/(<br>){3,}/g, '<br><br>')
                // Trim and limit length
                .trim()
                .substring(0, 800);

              // Escape for JSON output
              core.setOutput('body', JSON.stringify(cleanHtml));
            } catch (error) {
              console.log('Warning: Could not render markdown, using raw text');
              // Fallback: escape special chars and use raw text
              const escaped = releaseBody
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .substring(0, 800);
              core.setOutput('body', JSON.stringify(escaped));
            }

      - name: Send Google Chat notification
        env:
          WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}
        run: |
          # Build Cards v2 payload
          cat > payload.json << 'EOF'
          {
            "cardsV2": [
              {
                "cardId": "release-${{ github.event.release.id }}",
                "card": {
                  "header": {
                    "title": "ðŸš€ New Release: ${{ github.event.repository.name }}",
                    "subtitle": "${{ steps.release.outputs.version }}",
                    "imageUrl": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                    "imageType": "CIRCLE"
                  },
                  "sections": [
                    {
                      "header": "Release Notes",
                      "widgets": [
                        {
                          "textParagraph": {
                            "text": ${{ steps.release.outputs.body }}
                          }
                        }
                      ]
                    },
                    {
                      "widgets": [
                        {
                          "buttonList": {
                            "buttons": [
                              {
                                "text": "View Release",
                                "onClick": {
                                  "openLink": {
                                    "url": "${{ github.event.release.html_url }}"
                                  }
                                }
                              },
                              {
                                "text": "View Commits",
                                "onClick": {
                                  "openLink": {
                                    "url": "${{ github.event.repository.html_url }}/compare/${{ github.event.release.tag_name }}...main"
                                  }
                                }
                              },
                              {
                                "text": "Open Website",
                                "onClick": {
                                  "openLink": {
                                    "url": "https://r4c.dataportal.fi"
                                  }
                                }
                              }
                            ]
                          }
                        }
                      ]
                    }
                  ]
                }
              }
            ]
          }
          EOF

          # Send to Google Chat
          curl -X POST \
            -H "Content-Type: application/json" \
            -d @payload.json \
            "$WEBHOOK_URL"
