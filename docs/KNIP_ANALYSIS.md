# Knip Analysis Report - R4C Cesium Viewer

**Generated:** 2025-11-17
**Knip Version:** Latest
**Purpose:** Evaluate code cleanup opportunities and identify unused dependencies

> **‚ö†Ô∏è Note:** This report is a snapshot from the initial knip evaluation. As the codebase evolves, some findings may become outdated. For current dependency analysis, run `npm run lint:deps` locally or check the CI security-scan job results.

---

## Executive Summary

Knip identified 47 potential issues across the codebase. After manual verification, the findings break down as follows:

- **üî¥ CRITICAL:** 1 major dependency management issue (missing core dependencies)
- **üü¢ FALSE POSITIVES:** ~60% of flagged items are actually in use
- **üü° SAFE TO REMOVE:** ~20% can be safely cleaned up
- **üîµ NEEDS REVIEW:** ~20% require further investigation

---

## üî¥ CRITICAL ISSUE: Missing Core Dependencies

### Problem
**Vue, Vuetify, and Cesium are NOT declared in package.json** but are referenced in the build configuration.

**Evidence:**
- `vite.config.js:28` - References `cesium` in manual chunks
- `vite.config.js:30` - References `vue` in manual chunks
- `vite.config.js:31` - References `vuetify` in manual chunks
- `vite.config.js:95` - Includes these in `optimizeDeps`

**Risk:**
- Builds may break if transitive dependencies change
- Unreliable dependency resolution
- Violates npm best practices

**Recommendation:**
```bash
npm install --save vue vuetify cesium
```

---

## üü¢ FALSE POSITIVES (Do NOT Remove)

### Configuration Files
- **`eslint.config.js`** - ‚úÖ In active use (ESLint flat config)
- **`components.d.ts`** - ‚úÖ Auto-generated by unplugin-vue-components (vite.config.js:66)

### Stores (All actively imported)
- **`heatExposureStore.js`** - ‚úÖ Used in CesiumViewer.vue:58, ControlPanel.vue:291, SocioEconomicsChart.vue:10
- **`socioEconomicsStore.js`** - ‚úÖ Used in multiple components (CesiumViewer, ControlPanel, SocioEconomicsSelect)

### Composables
- **`useGridStyling.js`** - ‚úÖ Used in StatisticalGridOptions.vue, SosEco250mGrid.vue, LandcoverToParks.vue

### Services
- **`tiffImagery.js`** - ‚úÖ Used in PostalCodeNDVI.vue, MapControls.vue, Layers.vue

### Performance Testing
- **`tests/performance-config.ts`** - ‚úÖ Referenced in scripts/check-performance-regression.js
- **`tests/reporters/performance-reporter.ts`** - ‚úÖ Used in playwright.config.ts:33,40

### Dependencies (All actively used)
- **`@sentry/browser`** - ‚úÖ Used in src/main.js (error tracking)
- **`fast-xml-parser`** - ‚úÖ Used in src/components/HSYWMS.vue (WMS parsing)
- **`tiff-imagery-provider`** - ‚úÖ Used in src/services/tiffImagery.js (NDVI imagery)

### Dev Dependencies
- **`eslint-plugin-vue`** - ‚úÖ Used in eslint.config.js:2
- **`globals`** - ‚úÖ Likely used for ESLint global definitions

---

## üü° POTENTIALLY UNUSED (Investigate Further)

### Services & Stores
These files were flagged but need deeper investigation to determine if they're truly unused:

1. **`src/services/backgroundPreloader.js`** - May be legacy code
2. **`src/services/espooSurvey.js`** - Feature-specific, may be inactive
3. **`src/services/geocoding.js`** - Check if geocoding is handled elsewhere
4. **`src/services/graphics.js`** - May be superseded by other visualization code
5. **`src/services/loadingCoordinator.js`** - May be replaced by newer loading logic
6. **`src/stores/graphicsStore.js`** - Check if graphics state is managed elsewhere
7. **`src/stores/mitigationStore.js`** - Feature-specific, verify usage
8. **`src/composables/useIndexData.js`** - Check for dynamic imports

### Dependencies
1. **`path`** (package.json:54) - Built-in Node.js module, shouldn't be in dependencies
2. **`url`** (package.json:59) - Built-in Node.js module, shouldn't be in dependencies
3. **`typescript-eslint`** (package.json:57) - May be duplicate of existing TypeScript ESLint packages
4. **`supertest`** (devDependencies) - Check if API testing is actually implemented
5. **`vite-plugin-cesium`** (devDependencies) - Using `vite-plugin-cesium-build` instead (line 5 of vite.config.js)

---

## üîµ CODE QUALITY ISSUES

### Duplicate Exports
These files export both default and named exports of the same thing:

1. **`src/services/cacheService.js:370`** - Exports both `cacheService` and `default`
2. **`tests/e2e/helpers/test-helpers.ts`** - Exports both `AccessibilityTestHelpers` class and default

**Recommendation:** Choose one export style per file for consistency.

### Unused Exports (Test Utilities)
The following test utilities are exported but never imported elsewhere:

- `TEST_URLS` (tests/config/constants.ts:74)
- `POSTAL_CODE_RANGES` (tests/config/constants.ts:80)
- `isWebGLAvailable` (tests/e2e/helpers/cesium-helper.ts:94)
- `cleanupSceneIdleState` (tests/e2e/helpers/cesium-helper.ts:320)
- `TEST_TIMEOUTS` (tests/e2e/helpers/test-helpers.ts:22)
- `AccessibilityTestHelpers` class (tests/e2e/helpers/test-helpers.ts:40)
- `injectCesiumMock` (tests/mocks/cesium-mock.ts:453)
- `digitransitMockResponses` (tests/setup/digitransit-mock.ts:4)

**Note:** These may be intentionally exported for future use or external tooling.

### Unused Type Exports
TypeScript interfaces/types that aren't imported elsewhere (may be intended for documentation):

- `FeatureFlagConfig`, `FeatureFlagsMap`, `UserOverridesMap`, `FeatureFlagWithName` (featureFlagStore.ts)
- `ViewMode`, `NavigationLevel` (test-helpers.ts)
- `CesiumFixtures` (cesium-fixture.ts)
- `Page`, `TestHelper`, `ApiResponse`, `TestMetrics` (playwright.ts)

---

## üìã RECOMMENDED ACTIONS

### Immediate (High Priority)

1. **Add missing core dependencies:**
   ```bash
   npm install --save vue vuetify cesium
   ```

2. **Remove Node.js built-ins from dependencies:**
   ```bash
   npm uninstall path url
   ```

### Short-term (Medium Priority)

3. **Investigate and potentially remove:**
   - Verify `typescript-eslint` isn't duplicated
   - Check if `supertest` is actually used for API testing
   - Verify `vite-plugin-cesium` vs `vite-plugin-cesium-build` usage

4. **Review unused service files:**
   - Audit the 8 potentially unused services/stores/composables
   - Document decision to keep or remove each one
   - Add comments if keeping for future use

### Long-term (Low Priority)

5. **Clean up test utilities:**
   - Remove truly unused test exports
   - Document test utilities that should remain for tooling

6. **Standardize export patterns:**
   - Fix duplicate exports in cacheService.js and test-helpers.ts
   - Choose consistent export style (default vs named)

---

## ‚öôÔ∏è Knip Configuration Recommendations

Create a `knip.json` or `.knip.json` file to reduce false positives:

```json
{
  "entry": [
    "src/main.js",
    "vite.config.js",
    "playwright.config.ts",
    "tests/**/*.test.{js,ts}",
    "tests/**/*.spec.{js,ts}"
  ],
  "project": [
    "src/**/*.{js,ts,vue}",
    "tests/**/*.{js,ts}"
  ],
  "ignore": [
    "components.d.ts",
    "src/auto-imports.d.ts",
    "**/dist/**",
    "**/coverage/**"
  ],
  "ignoreDependencies": [
    "vue",
    "vuetify",
    "cesium"
  ]
}
```

---

## üìä Summary Statistics

| Category | Count | Action |
|----------|-------|--------|
| **False Positives** | 28 | Keep (actually used) |
| **Critical Issues** | 1 | Fix immediately |
| **Safe to Remove** | 2 | Remove (path, url) |
| **Needs Investigation** | 8 | Manual audit required |
| **Code Quality Issues** | 2 | Refactor exports |
| **Test Utilities** | 8 | Low priority cleanup |

---

## üéØ Next Steps

1. **Run the immediate fixes** (add vue/vuetify/cesium, remove path/url)
2. **Set up knip configuration** to reduce false positives
3. **Schedule time to audit** the 8 potentially unused service files
4. **Add a lint script** to package.json: `"lint:deps": "knip"`
5. **Integrate into CI** to prevent future dependency drift

---

## Notes

- Knip is a valuable tool but requires careful interpretation
- Many "unused" items are actually used via dynamic imports or Vue auto-imports
- The build configuration (vite.config.js) should be treated as a source of truth for what's actually used
- Regular knip audits can help prevent dependency bloat over time
