<!DOCTYPE html>
<html>
<head>
    <title>Scatter Plot with Plotly</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src='https://unpkg.com/simple-statistics@7.8.2/dist/simple-statistics.min.js'></script>
</head>
<body>
    <div id="plot"></div>

    <script>
        // Load data from GeoJSON file
        fetch('SensorsVsExposure.json')
            .then( response => response.json() )
            .then( data => {

                // Sort data.features array by heatExposureIndex
                const sortedFeatures = data.features.slice().sort((a, b) => {
                    const heatExposureA = Number(a.properties.heatExposureIndex);
                    const heatExposureB = Number(b.properties.heatExposureIndex);
                    return heatExposureA - heatExposureB;
                 });

                // Extract heat exposure values from GeoJSON properties and convert them to numbers
                const heatExposureValues = sortedFeatures.map( feature => Number( feature.properties.heatExposureIndex ) );

                // Extract temperature values from GeoJSON properties and convert them to numbers
                const temperatureValues = sortedFeatures.map( feature => Number( feature.properties.temperatureMean ) );

                // Extract addresses from GeoJSON properties
                const addresses = sortedFeatures.map( feature => feature.properties.address) ;

                // Calculate linear regression parameters using simple-statistics
                const regressionLine = ss.linearRegression(
                    heatExposureValues.map( ( value, index ) => [ value, temperatureValues[ index ] ] )
                );

                // Extract slope and intercept from the regression parameters
                const slope = regressionLine.m;
                const intercept = regressionLine.b;

                // Create x values for the regression line (using heat exposure values)
                const regressionX = heatExposureValues;

                // Calculate corresponding y values for the regression line using the linear equation
                const regressionY = regressionX.map( xVal => slope * xVal + intercept );
                // Calculate the differences between heat exposure and temperature values
                const differences = temperatureValues.map((heatValue, index) => heatValue - regressionY[index])
                // Calculate the sum of the differences between heat exposure and temperature values
                const sumOfDifferences = differences.reduce((sum, difference) => sum + difference, 0);

                // Calculate the sum of the squared differences (residual sum of squares)
                const residualSumOfSquares = differences.reduce((sum, difference) => sum + difference ** 2, 0);

                // Calculate the total sum of squares
                const meanSteadmanValue = ss.mean(temperatureValues);
                const totalSumOfSquares = temperatureValues.reduce((sum, value) => sum + (value - meanSteadmanValue) ** 2, 0);

                // Calculate the R-squared value
                const rSquared = 1 - (residualSumOfSquares / totalSumOfSquares);


                console.log( "slope", slope );
                console.log( "intercept", intercept );
                console.log( "differences from regression line", differences );
                console.log( "sum differences from regression line", sumOfDifferences );
                console.log("R-Squared:", rSquared);

                // Define trace for Heat Exposure Index
                const traces = [
                    {
                        x: regressionX,
                        y: regressionY,
                        mode: 'lines',
                        type: 'scatter',
                        name: 'Regression Line'
                    },
                    {
                        x: heatExposureValues,
                        y: temperatureValues,
                        mode: 'markers+text',
                        type: 'scatter',
                        marker: { color: 'blue', symbol: 'circle' },
                        text: addresses,
                        textposition: 'top center', // Position text slightly above the markers
                        name: 'Location'
                    }                    
                ];

                // Create layout with specific axis ranges
                const layout = {
                    title: 'Heat Exposure and Sensor Observations with regression line',
                    xaxis: { title: 'Heat Exposure Index' },
                    yaxis: { title: 'Mean Temperature (Â°C)' },
                    height: 600
                };

                // Create plot
                Plotly.newPlot( 'plot', traces, layout );
            })
            .catch( error => console.error( 'Error fetching data:', error ) );
    </script>
</body>
</html>