<!DOCTYPE html>
<html lang="en">
<head>
<title>3D Tiles - OGC API Features demo</title>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="Cesium/Cesium.js"></script>
  <script type="text/javascript" src="GeoAPITools.js"></script>
  <script src="localforage/dist/localforage.js"></script>
  <script src="plotly-2.12.1.min.js"></script>
  <link href="Cesium/Widgets/widgets.css" rel="stylesheet">
  <link href="DemoApp.css" rel="stylesheet">
</head>
<body>
<div id="canvasScalerDiv">
  <div id="cesiumContainer"></div>
  <div id="UIContainer">
  <p class="uiButton" onClick="reset()" style="color: red; float:right;">Reset</p>
 
  <!-- autoZoomSwitch-->
<label class="switch">
  <input type="checkbox" id="autoZoomToggle" value="autoZoom" checked>
  <span class="slider round"></span>
  
</label>
<label for="autoZoomToggle" class="label">Auto-zoom</label>

  <!-- showPlotSwitch-->
<label class="switch">
  <input type="checkbox" id="showPlotToggle" value="showPlot" checked>
  <span class="slider round"></span>
</label>
<label for="showPlotToggle" class="label">Display plot</label>

  <!-- showPrintSwitch-->
<label class="switch">
  <input type="checkbox" id="printToggle" value="print" checked>
  <span class="slider round"></span>
</label>
<label for="printToggle" class="label">Object details</label>

  <!-- showNatureSwitch-->
<label class="switch">
	<input type="checkbox" id="showNatureToggle" value="showNature" >
	<span class="slider round"></span>
</label>
<label for="showNatureToggle" class="label">Show nature areas</label>

  <!-- hideNonSoteSwitch-->
  <label class="switch">
	<input type="checkbox" id="hideNonSoteToggle" value="hideNonSote" >
	<span class="slider round"></span>
</label>
<label for="hideNonSote" class="label">Hide non sote buildings</label>

  <!-- showPlotSwitch-->
<label class="switch">
  <input type="checkbox" id="plotDailyToggle" value="plotDaily" checked>
  <span class="slider round"></span>
</label>
<label for="plotDailyToggle" class="label">Downsample timeseries</label>

  <!-- show3DCMSwitch-->
<label class="switch">
  <input type="checkbox" id="show3DCMToggle" value="show3DCM">
  <span class="slider round"></span>
</label>
<label for="show3DCMToggle" class="label">Display 3D city model</label>

  <!-- showUrbanHeatSwitch-->
<label class="switch">
  <input type="checkbox" id="showUrbanHeatToggle" value="showUrbanHeat" checked>
  <span class="slider round"></span>
</label>
<label for="showUrbanHeatToggle" class="label">Show Urban Heat Exposure</label>


  </div>
  <div id="plotContainer">
  
  </div>
  
	<div id="printContainer">
  <i>Please click on a postcode area to load building and lot polygons from the WFS server...</i>
  </div>
  	
  	<!-- Add Logo -->
	<img src="fvh-1_musta.png" id="logo" alt="Forum Virium Helsinki" />
	</div>
  <script>
  
  	// UI related global variables...
  	var autoZoom = true;
  	var showPlot = true;
  	var plotEnergy = true;
  	var plotDaily = true; //Alternatively, wil plot hourly
  	var lastEnergyPlotRATU = 0; //Will store the previous energy data point accessed..
	var showNature = false;
  	var show3DCM = false;
  	var tilesets = []; //Will store reference to loaded tilesets
  	var print = true; //show object details..
	var postalcode = null;
	var showUrbanHeat = true;
    
	// OS version, operating without Cesium Ion services...
    Cesium.Ion.defaultAccessToken = null;

    // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
    const viewer = new Cesium.Viewer('cesiumContainer', {
    	terrainProvider : new Cesium.EllipsoidTerrainProvider(),
		imageryProvider: new Cesium.WebMapTileServiceImageryProvider({
			url : ' https://avoin-karttakuva.maanmittauslaitos.fi/avoin/wmts/?api-key=97cd06ee-393a-4e7f-bd92-7ca33172df00',
			layer : 'taustakartta',
			style : 'default',
			tileMatrixSetID : 'WGS84_Pseudo-Mercator'
		}),
    	animation: false,
        fullscreenButton: false,
        geocoder: false,
        shadows: false,
        navigationHelpButton: false,
        timeline: false,
        sceneModePicker: false,
        baseLayerPicker: false,
        infoBox: false
    });    
  
    // Fly the camera to Helsinki at the given longitude, latitude, and height.
    viewer.camera.flyTo({
      destination : Cesium.Cartesian3.fromDegrees(24.941745, 60.165464, 35000), 
      orientation : {
        heading : Cesium.Math.toRadians(0.0),
        pitch : Cesium.Math.toRadians(-85.0),
      }
    });
    
    // Load post code zones & energy data availability tags
	loadPostCodeZones(0.2);
	loadEnergyAvailabilityAPI();
    
	//Experimental scripts for playing around with the objects, and retrieving their information...
	document.getElementById("cesiumContainer").addEventListener("click", function() { processClick(viewer, event) });

	function processClick(viewer, event) {
		console.log("Clicked at " + String(event.x) + ", " + String(event.y));
		pickEntity(viewer, new Cesium.Cartesian2(event.x, event.y));
	}
	    
	function pickEntity(viewer,windowPosition) {
		var picked = viewer.scene.pick(windowPosition);
		
		if(picked != undefined) {
			
			var id = Cesium.defaultValue(picked.id, picked.primitive.id);
			
			if (picked instanceof Cesium.Cesium3DTileFeature) {
				console.log("3D Tiles clicked!");
				console.log( "picked", picked );

				var propertyNames = picked.getPropertyNames();
		        
				document.getElementById('printContainer').scroll({
					  top: 0,
					  behavior: 'instant'
				});
				var toPrint = "<u>Found following properties & values:</u><br/>";
				        
				var length = propertyNames.length;
		        for (var i = 0; i < length; ++i) {
		            var propertyName = propertyNames[i];
		            toPrint = toPrint + propertyName + ': ' + picked.getProperty(propertyName) + "<br/>";
		        }

				if(picked.getProperty("attributes") != undefined) {
					console.log("...and following attributes & values:");
					toPrint = toPrint + "<u>...and following attributes & values:</u><br/>";
										
					var attributes = picked.getProperty("attributes");

					for (const property in attributes) {
		  				console.log(`${property}: ${attributes[property]}`);
		  				toPrint = toPrint + property + ": " + attributes[property] + "<br/>"
						}
					
					toPrint = toPrint + "<br/><br/><i>Click on objects to retrieve information. Red points indicate energy data availability.</i>"	
					document.getElementById('printContainer').innerHTML = toPrint;
					document.getElementById('printContainer').scroll({
						  top: 1000,
						  behavior: 'smooth'
					});
					
					if (attributes['Kerrosala'] != null && attributes['Kokonaisala'] != null) {
					//Plot some building data
					var data = [
		  			{
		   			 	labels: ['Kerrosala', 'Muu ala'],
		    			values: [parseInt((attributes['Kerrosala'])), parseInt((attributes['Kokonaisala']))-parseInt((attributes['Kerrosala']))],
		    			type: 'pie'
		  			}
					];
				
					var layout = {
						  title: {
						    text:'Kerrosalan osuus kokonaisalasta'}};
					
					//Test plotting
					if(showPlot == true) {
						document.getElementById("plotContainer").style.visibility = 'visible';
					}
					Plotly.newPlot('plotContainer', data, layout);
					lastEnergyPlotRATU = 0;
					} else {
						console.log("Could not plot due to insufficient data...");
						document.getElementById('plotContainer').style.visibility='hidden';
					}
					
/* 					if(attributes['Rakennustunnus_(RATU)'] != null) {
						if(plotEnergy == true) {loadEnergyTimeSeries(attributes['Rakennustunnus_(RATU)']);}
					} else if (attributes['RATU'] != null)
						if(plotEnergy == true) {loadEnergyTimeSeries(attributes['RATU']);} */
					}
					
			} else if (picked.id._polygon != undefined) {
				var bbox = findEntityBounds(picked.id);
			
				var buffer = 0.000005 //Buffer for bounding box, somewhat complex as in radians...
			
		    	var rectangle = new Cesium.Rectangle(bbox[2] - buffer, bbox[0] - buffer, bbox[3] + buffer, bbox[1] + buffer);
		    	if (autoZoom == true) {
				viewer.camera.flyTo({
		        	destination: rectangle,
		        	orientation:  {
		            	heading : Cesium.Math.toRadians(0.0),
		            	pitch : Cesium.Math.toRadians(-90.0),
		            	roll : 0.0
		        	},
		        	duration: 5
		    	});
		    	}
			
			if (id instanceof Cesium.Entity) {
				
				document.getElementById('printContainer').scroll({
					  top: 0,
					  behavior: 'instant'
				});
				
				if (picked.id._polygon != undefined && picked.id.properties != undefined) {
					var toPrint = "<u>Found following properties & values:</u><br/>";	

				//Highlight for clicking...
				var oldMaterial = id.polygon.material;
				id.polygon.material = new Cesium.Color(1, 0.5, 0.5, 0.8);
				setTimeout(() => {id.polygon.material = oldMaterial}, 500);
				
				console.log( "properties ", picked.id.properties );
				console.log( "picked ", picked );

				var length = picked.id.properties.propertyNames.length;
				for (var i = 0; i < length; ++i) {
					toPrint = toPrint + picked.id.properties.propertyNames[i] + ": " + picked.id.properties[picked.id.properties.propertyNames[i]] + "<br/>";
					};
				}
				
				console.log(toPrint);
				
				toPrint = toPrint + "<br/><br/><i>Click on objects to retrieve information. Red points indicate energy data availability.</i>"
				document.getElementById('printContainer').innerHTML = toPrint;
				document.getElementById('printContainer').scroll({
					  top: 1000,
					  behavior: 'smooth'
				});
			}
			
			if (picked.id.properties != null) {
			
			//If we find postal code, we assume this is an area & zoom in AND load the buildings for it.
			if ( picked.id.properties.postinumeroalue != null ) {

				console.log("Postal code area found!");

				postalcode = picked.id.properties.postinumeroalue;

				viewer.dataSources.removeAll();
				viewer.entities.removeAll();
			    
			    if ( show3DCM == false ) {

					if ( showNature ) {

						loadWFSNatureAreas( picked.id.properties.postinumeroalue );

					}

					console.log( picked.id.properties.postinumeroalue )
			    	loadWFSBuildings( picked.id.properties.postinumeroalue );

 			    }
			    

				if ( !showUrbanHeat ) {

					loadHKIWFSLots( picked.id.properties.postinumeroalue );

				}
		//	    loadEnergyAvailabilityAPI(picked.id.properties.posno._value);
			    
			    loadPostCodeZones( 0.0 );
			}
			
			//See if we can find a Helsinki Lot polygon with information on usable building floor area
			if (picked.id.properties.tonttijakotunnus != null) {

				var data = [
		  			{
		  				
		  		 		x: ['Rekisteriala', 'Rakennusoikeus'],
		    			y: [parseInt(picked.id.properties._rekisteriala._value), parseInt(picked.id.properties._rakennusoikeus._value)],
		    			marker:{
		    				color: ['rgba(180,180,180,1)','rgba(80,80,80,1)']
		    			},
		    			type: 'bar'}];
		
				var layout = {
						  title: {
						    text:'Rekisteriala & Rakennusoikeus'}};
					
				//Test plotting
				if(showPlot == true) {
					document.getElementById("plotContainer").style.visibility = 'visible';
				}
				Plotly.newPlot('plotContainer', data, layout);
				lastEnergyPlotRATU = 0;
				
			}
			
			//See if we can find a SeutuRAMAVA polygon with information on unbuilt floor areas
			if (picked.id.properties.laskvar_yh != null) {
				var data = [
		  			{
		  				
		  		 		labels: ['Laskennallinen kerrostalovaranto', 'Laskennallinen pientalovaranto', 'Laskennallinen liike- ja toimistotilavaranto', 'Laskennallinen teollisuus- ja varastotilavaranto', 'Laskennallinen julkisen rakentamisen varanto', 'Laskennallinen muu kuin yllä mainittujen käyttötarkoitusten varanto', 'Käyttöönotettu asuinkerrosala', 'Käyttöönotettu muu kuin asuinkerrosala'],
		    			values: [parseInt(picked.id.properties.laskvar_ak), parseInt(picked.id.properties.laskvar_ap), parseInt(picked.id.properties.laskvar_k), parseInt(picked.id.properties.laskvar_t), parseInt(picked.id.properties.laskvar_y), parseInt(picked.id.properties.laskvar_nn), parseInt(picked.id.properties.karaas), parseInt(picked.id.properties.karamu)],
		    			type: 'pie'
		  			}
					];
				
				var layout = {
						  title: {
						    text:'Kerrosalan jakautuminen korttelialueella (kerrosneliömetriä)'}};
					
				//Test plotting
				if(showPlot == true) {
					document.getElementById("plotContainer").style.visibility = 'visible';
				}
				Plotly.newPlot('plotContainer', data, layout);
				lastEnergyPlotRATU = 0;
				
			}
			
			//See if we can find building floor areas
			if (picked.id.properties.i_kokala != null) {
				console.log("Building found!");

				var data = [
		  			{
		   			 	labels: ['Kerrosala', 'Muu ala'],
		    			values: [parseInt(picked.id.properties.i_kerrosala), parseInt(picked.id.properties.i_kokala)-parseInt(picked.id.properties.i_kerrosala)],
		    			type: 'pie'
		  			}
					];
				
				var layout = {
						  title: {
						    text:'Kerrosalan osuus kokonaisalasta'}};
					
				//Test plotting
				if(showPlot == true) {
					document.getElementById("plotContainer").style.visibility = 'visible';
				}
				Plotly.newPlot('plotContainer', data, layout);
				lastEnergyPlotRATU = 0;
				
				// Query energy API
/* 				if (picked.id.properties.ratu != null) {
					if(plotEnergy == true) {loadEnergyTimeSeries(picked.id.properties.ratu);}
				}  */
			}
			}
		}
	}
	}
	
	//Attaching UI events...
	addEventListener('input', (event) => {sliderEvents(event)});
	
	function sliderEvents(event) {
		if (event.target.value == 'autoZoom') {
			console.log("Set the autozoom to: " + String(document.getElementById("autoZoomToggle").checked));
			autoZoom = document.getElementById("autoZoomToggle").checked;
		}
		
		if (event.target.value == 'print') {
			console.log("Set the print to: " + String(document.getElementById("printToggle").checked));
			print = document.getElementById("printToggle").checked;
		
			if (print == false) {
				document.getElementById('printContainer').style.visibility='hidden';
			} else {
				document.getElementById('printContainer').style.visibility='visible';
			}
		}
		
		if (event.target.value == 'plotEnergy') {
			console.log("Set the plotenergy to: " + String(document.getElementById("plotEnergyToggle").checked));
			plotEnergy = document.getElementById("plotEnergyToggle").checked;
		}
		
		if (event.target.value == 'plotDaily') {
			console.log("Set the plotdaily to: " + String(document.getElementById("plotDailyToggle").checked));
			plotDaily = document.getElementById("plotDailyToggle").checked;
			if (lastEnergyPlotRATU != 0) {
//				loadEnergyTimeSeries(lastEnergyPlotRATU); //Ask for a re-plot
			}
		}
		
		if (event.target.value == 'showPlot') {
			console.log("Set the showplot to: " + String(document.getElementById("showPlotToggle").checked));
			showPlot = document.getElementById("showPlotToggle").checked;
			
			if (showPlot == false) {
				document.getElementById('plotContainer').style.visibility='hidden';
			}
			
			if (showPlot == true) {
				if (document.getElementById('plotContainer').textContent.includes("plotly")) { //This is a bit dirty...
					document.getElementById('plotContainer').style.visibility='visible';
				}
			}
		}
		
		if (event.target.value == 'show3DCM') {
			show3DCM = document.getElementById("show3DCMToggle").checked;
			
			if (show3DCM == false) {
				// Hide 3D city model...
				tilesets.forEach(function (tileset){
					tileset.show = false;
				});
				
				viewer.dataSources._dataSources.forEach(function(dataSource) {
					dataSource.show = true;
				});
				
			} else {
				
				// Hide 2D building polygons, if displayed...
				viewer.dataSources._dataSources.forEach(function(dataSource) {
					if(dataSource.name == "Buildings") {
						dataSource.show = false;	
					}
				});
				
				// Add Helsinki 3D-tiles.
				if(tilesets.length == 0) {
			    	const hkiTileSet = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
			    		url : 'https://kartta.hel.fi/3d/datasource-data/e9cfc1bb-a015-4a73-b741-7535504c61bb/tileset.json',
			    		maximumScreenSpaceError: 4
					}));
			    	tilesets.push(hkiTileSet);
			    } 
				tilesets.forEach(function (tileset){
					tileset.show = true;
				});
			}
		}

		if ( event.target.value == 'showNature' ) {

			showNature = document.getElementById( "showNatureToggle" ).checked;

			if ( showNature ) {

				if ( postalcode && viewer.dataSources._dataSources.length > 2 ) {

					loadWFSNatureAreas( postalcode );

				}
				
				viewer.dataSources._dataSources.forEach( function( dataSource ) {

					dataSource.show = true;

				});

			} else {

				viewer.dataSources._dataSources.forEach( function( dataSource ) {

					if( dataSource.name == "NatureAreas" ) {

						dataSource.show = false;	
						
					}
				});

			}

		}

		if ( event.target.value == 'hideNonSote' ) {
			
			hideNonSote = document.getElementById( "hideNonSoteToggle" ).checked;

			if ( hideNonSote ) {
				
				viewer.dataSources._dataSources.forEach( function( dataSource ) {
					
					if ( dataSource.name == "Buildings" ) {

						for ( let i = 0; i < dataSource._entityCollection._entities._array.length; i++ ) {

							let entity = dataSource._entityCollection._entities._array[ i ];

							if ( !entity._properties._avgheatexposuretobuilding ) {

								dataSource._entityCollection._entities._array[ i ].show = false;

							}
						}						
					}
				});

			} else {

				viewer.dataSources._dataSources.forEach( function( dataSource ) {
					
					if ( dataSource.name == "Buildings" ) {

						for ( let i = 0; i < dataSource._entityCollection._entities._array.length; i++ ) {

							dataSource._entityCollection._entities._array[ i ].show = true;

						}						
					}
				});
			}
		}	
		
		if ( event.target.value == 'showUrbanHeat' ) {
			
			showUrbanHeat = document.getElementById( "showUrbanHeatToggle" ).checked;

			if ( showUrbanHeat ) {
				viewer.dataSources._dataSources.forEach( function( dataSource ) {

					if( dataSource.name == "HKI Lots" ) {
						
						dataSource.show = false;	
					}});
				
			} else {

				if ( postalcode && viewer.dataSources._dataSources.length > 2 ) {
					
					loadHKIWFSLots( postalcode );
				
				}

			}

		}		

	}
  </script>
</body>
</html>