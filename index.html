<!DOCTYPE html>
<html lang="en">
<head>
<title>R4C demo</title>
  <meta charset="utf-8">
  <!-- Include the CesiumJS JavaScript and CSS files -->
  <script src="Cesium/Cesium.js"></script>
  <script type="text/javascript" src="GeoAPITools.js"></script>
  <script src="localforage/dist/localforage.js"></script>
  <script src="plotly-2.12.1.min.js"></script>
  <link href="Cesium/Widgets/widgets.css" rel="stylesheet">
  <link href="DemoApp.css" rel="stylesheet">
</head>
<body>
<div id="canvasScalerDiv">
  <div id="cesiumContainer"></div>
  <div id="UIContainer">
  <p class="uiButton" onClick="reset()" style="color: red; float:right;">Reset</p>
 
  <!-- showPlotSwitch-->
<label class="switch">
  <input type="checkbox" id="showPlotToggle" value="showPlot" checked>
  <span class="slider round"></span>
</label>
<label for="showPlotToggle" class="label">Display plot</label>

  <!-- showPrintSwitch-->
<label class="switch">
  <input type="checkbox" id="printToggle" value="print" checked>
  <span class="slider round"></span>
</label>
<label for="printToggle" class="label">Object details</label>

  <!-- showNatureSwitch-->
<label class="switch">
	<input type="checkbox" id="showNatureToggle" value="showNature" >
	<span class="slider round"></span>
</label>
<label for="showNatureToggle" class="label">Show nature areas</label>

  <!-- hideNonSoteSwitch-->
  <label class="switch">
	<input type="checkbox" id="hideNonSoteToggle" value="hideNonSote" >
	<span class="slider round"></span>
</label>
<label for="hideNonSote" class="label">Hide non sote buildings</label>

  </div>
  <div id="plotContainer">
  
  </div>
  
	<div id="printContainer">
  <i>Please click on a postcode area to load building and lot polygons from the WFS server...</i>
  </div>
  	
  	<!-- Add Logo -->
	<img src="fvh-1_musta.png" id="logo" alt="Forum Virium Helsinki" />
	</div>
  <script>
  
  	// UI related global variables...
  	var showPlot = true;
	var showNature = false;
  	var print = true; //show object details..
	var postalcode = null;
    
	// OS version, operating without Cesium Ion services...
    Cesium.Ion.defaultAccessToken = null;

    // Initialize the Cesium Viewer in the HTML element with the `cesiumContainer` ID.
    const viewer = new Cesium.Viewer('cesiumContainer', {
    	terrainProvider : new Cesium.EllipsoidTerrainProvider(),
		imageryProvider: new Cesium.WebMapTileServiceImageryProvider({
			url : ' https://avoin-karttakuva.maanmittauslaitos.fi/avoin/wmts/?api-key=97cd06ee-393a-4e7f-bd92-7ca33172df00',
			layer : 'taustakartta',
			style : 'default',
			tileMatrixSetID : 'WGS84_Pseudo-Mercator'
		}),
    	animation: false,
        fullscreenButton: false,
        geocoder: false,
        shadows: false,
        navigationHelpButton: false,
        timeline: false,
        sceneModePicker: false,
        baseLayerPicker: false,
        infoBox: false
    });    
  
    // Fly the camera to Helsinki at the given longitude, latitude, and height.
    viewer.camera.flyTo({
      destination : Cesium.Cartesian3.fromDegrees(24.941745, 60.165464, 35000), 
      orientation : {
        heading : Cesium.Math.toRadians(0.0),
        pitch : Cesium.Math.toRadians(-85.0),
      }
    });
    
    // Load post code zones & energy data availability tags
	loadPostCodeZones(0.2);
    
	//Experimental scripts for playing around with the objects, and retrieving their information...
	document.getElementById("cesiumContainer").addEventListener("click", function() { processClick( viewer, event ) });
	//Attaching UI events...
	addEventListener('input', ( event ) => { sliderEvents( event ) } );

	function processClick( viewer, event ) {
		console.log("Clicked at " + String( event.x ) + ", " + String( event.y ));
		pickEntity( viewer, new Cesium.Cartesian2( event.x, event.y ) );
	}
	    
	function pickEntity( viewer, windowPosition ) {
		let picked = viewer.scene.pick( windowPosition );
		
		if ( picked ) {
			
			let id = Cesium.defaultValue( picked.id, picked.primitive.id );
			
			if ( picked.id._polygon ) {

				let bbox = findEntityBounds( picked.id );
				let buffer = 0.000005 //Buffer for bounding box, somewhat complex as in radians...
				
				if ( id instanceof Cesium.Entity ) {
					
					document.getElementById( 'printContainer' ).scroll({
						top: 0,
						behavior: 'instant'
					});
					
					if ( picked.id._polygon && picked.id.properties ) {
						var toPrint = "<u>Found following properties & values:</u><br/>";	
				
						//Highlight for clicking...
						let oldMaterial = id.polygon.material;
						id.polygon.material = new Cesium.Color( 1, 0.5, 0.5, 0.8 );
						setTimeout(() => { id.polygon.material = oldMaterial }, 500 );
				
						console.log( "properties ", picked.id.properties );
						console.log( "picked ", picked );

						let length = picked.id.properties.propertyNames.length;
						for ( let i = 0; i < length; ++i ) {

							toPrint = toPrint + picked.id.properties.propertyNames[ i ] + ": " + picked.id.properties[ picked.id.properties.propertyNames[ i ] ] + "<br/>";
							
						};
					}
				
					console.log(toPrint);
				
					toPrint = toPrint + "<br/><br/><i>Click on objects to retrieve information. Red points indicate energy data availability.</i>"
					document.getElementById('printContainer').innerHTML = toPrint;
					document.getElementById('printContainer').scroll({
					  	top: 1000,
					  	behavior: 'smooth'
					});
				}
				
				if ( picked.id.properties ) {
					
					//If we find postal code, we assume this is an area & zoom in AND load the buildings for it.
					if ( picked.id.properties.postinumeroalue ) {
						
						let rectangle = new Cesium.Rectangle( bbox[ 2 ] - buffer, bbox[ 0 ] - buffer, bbox[ 3 ] + buffer, bbox[ 1 ] + buffer );
						
						viewer.camera.flyTo({
							destination: rectangle,
							orientation:  {
								heading : Cesium.Math.toRadians( 0.0 ),
		            			pitch : Cesium.Math.toRadians( -90.0 ),
		            			roll : 0.0
							},
							duration: 5
						});

						console.log("Postal code area found!");
						postalcode = picked.id.properties.postinumeroalue;
						viewer.dataSources.removeAll();
						viewer.entities.removeAll();
						
						if ( showNature ) {
							
							loadWFSNatureAreas( picked.id.properties.postinumeroalue );
						
						}

						console.log( picked.id.properties.postinumeroalue );
						loadWFSBuildings( picked.id.properties.postinumeroalue );			    
						loadPostCodeZones( 0.0 );
					}
			
					//See if we can find building floor areas
					if ( picked.id.properties.i_kokala ) {
						
						console.log("Building found!");
						
						let data = [
							{
								labels: [ 'Kerrosala', 'Muu ala' ],
		    				values: [ parseInt(picked.id.properties.i_kerrosala), parseInt( picked.id.properties.i_kokala ) - parseInt( picked.id.properties.i_kerrosala ) ],
		    				type: 'pie'
		  				}
						];
				
						let layout = { title: { text: 'Kerrosalan osuus kokonaisalasta' } };
					
						//Test plotting
						if ( showPlot ) {
							document.getElementById("plotContainer").style.visibility = 'visible';
						}
						Plotly.newPlot( 'plotContainer', data, layout );
				
					}
				}
			}
		}
	}
	
	function sliderEvents( event ) {
		
		if ( event.target.value == 'print' ) {
			console.log( "Set the print to: " + String( document.getElementById( "printToggle" ).checked ) );
			print = document.getElementById( "printToggle" ).checked;
		
			if ( !print ) {
				document.getElementById( 'printContainer' ).style.visibility = 'hidden';
			} else {
				document.getElementById( 'printContainer' ).style.visibility = 'visible';
			}
		}
			
		if ( event.target.value == 'showPlot' ) {
			console.log("Set the showplot to: " + String(document.getElementById("showPlotToggle").checked));
			showPlot = document.getElementById( "showPlotToggle" ).checked;
			
			if ( !showPlot ) {
				document.getElementById( 'plotContainer' ).style.visibility = 'hidden';
			}
			
			if ( showPlot ) {
				if ( document.getElementById( 'plotContainer' ).textContent.includes( "plotly" ) ) { //This is a bit dirty...
					document.getElementById( 'plotContainer' ).style.visibility = 'visible';
				}
			}
		}	

		if ( event.target.value == 'showNature' ) {

			showNature = document.getElementById( "showNatureToggle" ).checked;

			if ( showNature ) {

				if ( postalcode && viewer.dataSources._dataSources.length > 1 ) {

					loadWFSNatureAreas( postalcode );

				}
				
				viewer.dataSources._dataSources.forEach( function( dataSource ) {

					dataSource.show = true;

				});

			} else {

				viewer.dataSources._dataSources.forEach( function( dataSource ) {

					if( dataSource.name == "NatureAreas" ) {

						dataSource.show = false;	
						
					}
				});

			}

		}

		if ( event.target.value == 'hideNonSote' ) {
			
			hideNonSote = document.getElementById( "hideNonSoteToggle" ).checked;

			if ( hideNonSote ) {
				
				viewer.dataSources._dataSources.forEach( function( dataSource ) {
					
					if ( dataSource.name == "Buildings" ) {

						for ( let i = 0; i < dataSource._entityCollection._entities._array.length; i++ ) {

							let entity = dataSource._entityCollection._entities._array[ i ];

							if ( !entity._properties._avgheatexposuretobuilding || entity._properties._kayttotarkoitus == 'n/a') {

								dataSource._entityCollection._entities._array[ i ].show = false;

							}
						}						
					}
				});

			} else {

				viewer.dataSources._dataSources.forEach( function( dataSource ) {
					
					if ( dataSource.name == "Buildings" ) {

						for ( let i = 0; i < dataSource._entityCollection._entities._array.length; i++ ) {

							dataSource._entityCollection._entities._array[ i ].show = true;

						}						
					}
				});
			}
		}	
				
	}
  </script>
</body>
</html>