image:
  repository: ghcr.io/forumviriumhelsinki/r4c-cesium-viewer
  tag: '1.38.1'
imagePullSecrets:
- name: ghcr-login-secret
serviceAccount:
  create: true
  name: r4c-cesium-viewer
  annotations:
    iam.gke.io/gcp-service-account: pygeoapi@fvh-project-containers-etc.iam.gserviceaccount.com
# Cloud SQL Proxy for both app and migrations
initContainers:
- name: cloud-sql-proxy
  image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.16.0
  restartPolicy: Always
  args:
  - '--structured-logs'
  - '--port=5432'
  - '--auto-iam-authn'
  - 'fvh-project-containers-etc:europe-north1:fvh-postgres'
  securityContext:
    runAsNonRoot: true
    runAsUser: 65532
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
      - ALL
  resources:
    limits:
      cpu: 100m
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi
# Database migrations (Helm hook - runs before deployment)
migrations:
  enabled: true
  command: ['sh', '-c']
  args:
  - |
    set -e
    echo "Starting database migrations..."

    # Ensure PostGIS extensions exist
    echo "Ensuring PostGIS extensions..."
    psql "$DATABASE_URL" -c "CREATE EXTENSION IF NOT EXISTS postgis;" || echo "PostGIS may already exist"
    psql "$DATABASE_URL" -c "CREATE EXTENSION IF NOT EXISTS postgis_topology;" || echo "PostGIS topology may already exist"

    # Run migrations
    echo "Running migrations..."
    dbmate status || echo "First run"

    if dbmate up; then
      echo "Migrations complete"

      # Verify critical table exists
      if psql "$DATABASE_URL" -c "SELECT 1 FROM r4c_hsy_building_current LIMIT 1;" > /dev/null 2>&1; then
        echo "Verified r4c_hsy_building_current"
      else
        echo "Missing r4c_hsy_building_current"
        exit 1
      fi
    else
      echo "Migration failed"
      exit 1
    fi

    echo "Migrations completed successfully"
  env:
  - name: DATABASE_URL
    value: 'postgresql://pygeoapi%40fvh-project-containers-etc.iam@127.0.0.1:5432/regions4climate?sslmode=disable'
  - name: DBMATE_MIGRATIONS_DIR
    value: /migrations
  - name: DBMATE_NO_DUMP_SCHEMA
    value: 'true'
  waitForDatabase:
    enabled: true
    host: 127.0.0.1
    port: 5432
    user: 'pygeoapi@fvh-project-containers-etc.iam'
    timeout: 300
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 200m
      memory: 256Mi
ingress:
  annotations:
    nginx.ingress.kubernetes.io/auth-url: 'https://$host/oauth2/auth'
    nginx.ingress.kubernetes.io/auth-signin: 'https://$host/oauth2/start?rd=$escaped_request_uri'
    nginx.ingress.kubernetes.io/auth-response-headers: 'X-Auth-Request-User,X-Auth-Request-Email'
    cert-manager.io/cluster-issuer: 'letsencrypt-prod'
  enabled: true
  className: nginx
  hosts:
  - host: r4c.dataportal.fi
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls:
  - hosts:
    - r4c.dataportal.fi
    secretName: r4c-tls # pragma: allowlist secret
env:
- name: SENTRY_AUTH_TOKEN
  valueFrom:
    secretKeyRef:
      name: regions4climate-secrets # pragma: allowlist secret
      key: SENTRY_AUTH_TOKEN
- name: VITE_SENTRY_DSN
  valueFrom:
    secretKeyRef:
      name: regions4climate-secrets # pragma: allowlist secret
      key: VITE_SENTRY_DSN
- name: SENTRY_DSN
  valueFrom:
    secretKeyRef:
      name: regions4climate-secrets # pragma: allowlist secret
      key: SENTRY_DSN
- name: VITE_DIGITRANSIT_KEY
  valueFrom:
    secretKeyRef:
      name: regions4climate-secrets # pragma: allowlist secret
      key: VITE_DIGITRANSIT_KEY
- name: VITE_PYGEOAPI_HOST
  value: 'pygeoapi-helm-webapp.pygeoapi.svc.cluster.local'
- name: VITE_PYGEOAPI_URL
  value: 'https://pygeoapi.dataportal.fi'
replicaCount: 1
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 500m
    memory: 512Mi
# Security context for main container
# Required by Kyverno policies: disallow-privilege-escalation, require-ro-rootfs
securityContext:
  runAsNonRoot: true
  runAsUser: 101 # nginx user in official nginx image
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
    - ALL
# Volumes required for nginx with readOnlyRootFilesystem
volumes:
- name: nginx-cache
  emptyDir: {}
- name: nginx-run
  emptyDir: {}
- name: tmp
  emptyDir: {}
volumeMounts:
- name: nginx-cache
  mountPath: /var/cache/nginx
- name: nginx-run
  mountPath: /var/run
- name: tmp
  mountPath: /tmp
keda:
  enabled: true
  minReplicaCount: 0
  maxReplicaCount: 1
  pollingInterval: 30
  cooldownPeriod: 300
  triggers:
  - type: cron
    metadata:
      timezone: Europe/Helsinki
      start: 0 7 * * 1-5
      end: 0 20 * * 1-5
      desiredReplicas: '1'
